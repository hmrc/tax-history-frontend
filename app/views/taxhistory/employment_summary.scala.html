@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import model.api.{Employment, Allowance}
@import models.taxhistory.Person
@import utils.{Currency, DateHelper, ControllerUtils}
@import uk.gov.hmrc.time.TaxYear
@import config.AppConfig

@import model.api.TaxAccount
@(nino: String,
    taxYear: Int,
    employments: List[Employment],
    allowances: List[Allowance],
    person: Option[Person],
    taxAccount: Option[TaxAccount])(implicit request: Request[_], messages: Messages, appConfig: AppConfig)

@getName=@{
    person.fold(nino) {
         p => p.getName.fold(nino)(name => name)
    }
}

@views.html.main_template(title = Messages("employmenthistory.title")) {

  <a href="@controllers.routes.SelectTaxYearController.getSelectTaxYearPage().url" class="link-back" id="back-link">@Messages("lbl.back")</a>

    <div class="page-header" >
      <h1 class="heading-xlarge">
        @Messages("employmenthistory.header", getName)
      </h1>

      <p id="taxYearRange" class="heading-secondary">@Messages("employmenthistory.taxyear", taxYear.toString, (taxYear+1).toString)</p>
    </div>

    <div class="panel-indent panel-border-wide">
        <p id="disclaimer-0">
           @Messages("employmenthistory.caveat.p1.text")
        </p>
        <p id="disclaimer-1">
            @Messages("employmenthistory.caveat.p2.text")
        </p>
        <p id="disclaimer-2">
            @Messages("employmenthistory.caveat.p3.text")
        </p>
    </div>

@if(employments.exists(!_.receivingOccupationalPension)) {
    <h2 id = "EmploymentDetails" class="heading-medium">@Messages("employmenthistory.table.header.employments")</h2>
    <table id="employment-table">
        <tbody>
        <tr>
        <th scope="col" class="width20pc">@Messages("lbl.employer")</th>
        <th scope="col" class="width20pc">@Messages("lbl.date.start")</th>
        <th scope="col" class="width20pc">@Messages("lbl.date.end")</th>
         <th scope="col" class ="width20pc">@Messages("lbl.status")</th>
        <th scope="col" class="width20pc alignRight">@Messages("lbl.Actions")</th>
        </tr>
        @employments.filter(!_.receivingOccupationalPension).zipWithIndex.map { case (employment, index) =>
            <tr>
                <td>@employment.employerName</td>
                <td>@DateHelper.formatDate(employment.startDate)</td>
                <td>@ControllerUtils.getEndDate(employment)</td>
                <td>@ControllerUtils.getEmploymentStatus(employment)</td>
                <td id=@{s"view-employment-${index}"}>
                    @if(ControllerUtils.hasEmploymentDetails(employment)) {
                        <a href="/tax-history/single-record@employment.employmentURI" class="float-right"
                        onClick="ga('send', 'event', 'Employments', 'Click', 'View Record')"
                        >@Messages("employmenthistory.view.record")
                        <span class="visuallyhidden">@Messages("employmenthistory.view.record.hidden",getName,employment.employerName)</span></a>
                    } else {
                        @Messages("lbl.none")
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
}

    @if(employments.exists(_.receivingOccupationalPension)) {
        <h2 id = "Pensions"class="heading-medium">@Messages("employmenthistory.table.header.pensions")</h2>

        <table id="pension-table">
            <tbody>
            <tr>
            <th scope="col" class="width26pc">@Messages("lbl.provider")</th>
            <th scope="col" class="width27pc">@Messages("lbl.date.start")</th>
            <th scope="col" class="width27pc">@Messages("lbl.date.end")</th>
            <th scope="col" class="width20pc alignRight">@Messages("lbl.Actions")</th>
            </tr>
            @employments.filter(_.receivingOccupationalPension).zipWithIndex.map { case (employment, index) =>
            <tr>
                <td> @employment.employerName</td>
                <td>@DateHelper.formatDate(employment.startDate)</td>
                <td>@ControllerUtils.getEndDate(employment)</td>
                <td><a href="/tax-history/single-record@employment.employmentURI"
                onClick="ga('send', 'event', 'Pensions', 'Click', 'View Record')"
                       class="float-right" id=@{s"view-pension-${index}"}>@Messages("employmenthistory.view.record")
                    <span class="visuallyhidden">@Messages("employmenthistory.view.record.hidden",getName,employment.employerName)</span></a>
                </td>
            </tr>
            }
            </tbody>
        </table>
    }



    @if(allowances.nonEmpty) {
    <h2 id = "Allowances" class="heading-medium">@Messages("employmenthistory.allowance.heading")</h2>
        <table id="allowanceTable" >
          <thead>
            <tr>
              <th>@Messages("lbl.allowance")</th>
              <th class="numeric">@Messages("lbl.amount")</th>
            </tr>
          </thead>
          <tbody>
          @allowances.map {allowance =>
            <tr>
              <td>@Messages(s"employmenthistory.al.${allowance.iabdType}")</td>
              <td class="numeric">@Currency(allowance.amount)</td>
            </tr>
          }
          </tbody>
        </table>
    }

    @if(taxAccount.nonEmpty) {
        <h2 id = "UnderpaidTaxAndDebts" class="heading-medium">@Messages("employmenthistory.tax-account.header")</h2>
        <table id="taxAccountTable">
            <thead>
                <tr>
                    <th scope="col" class="width75pc">@Messages("lbl.details")</th>
                    <th scope="col" class="numeric width25pc">@Messages("lbl.amount")</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>@Messages("employmenthistory.tax-account.underpayment-amount.title",
                        s"${TaxYear.current.previous.currentYear}", s"${TaxYear.current.previous.finishYear}")</td>
                    <td class="numeric">@Currency(taxAccount.get.underpaymentAmount.getOrElse(0), 2)</td>
                </tr>

                <tr>
                    <td style = "border:0">@Messages("employmenthistory.tax-account.potential-underpayment.title",
                        s"${TaxYear.current.previous.currentYear}",s"${TaxYear.current.previous.finishYear}",
                        s"${TaxYear.current.currentYear}",s"${TaxYear.current.finishYear}")</td>
                    <td style = "border:0" class="numeric">@Currency(taxAccount.get.actualPUPCodedInCYPlusOneTaxYear.getOrElse(0), 2)</td>
                </tr>

                <tr>
                    <td colspan="2">
                        <details>
                            <summary>
                                <span class="summary">@Messages("employmenthistory.tax-account.potential-underpayment.summary")</span>
                            </summary>
                            <div class="panel-border-narrow panel" id="details-content-0">
                                <p>@Messages("employmenthistory.tax-account.potential-underpayment.content")</p>
                            </div>
                        </details>
                    </td>
                </tr>

                <tr>
                    <td>@Messages("employmenthistory.tax-account.outstanding.debt.title",
                        s"${TaxYear.current.previous.currentYear}",s"${TaxYear.current.previous.finishYear}")</td>
                    <td class="numeric">@Currency(taxAccount.get.outstandingDebtRestriction.getOrElse(0), 2)</td>
                </tr>
            </tbody>
        </table>
    }
}

